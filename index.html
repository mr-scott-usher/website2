<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneCampus Admin Portal</title>
  <style>
    :root {
      --bg: #eef3f8;
      --card: #ffffff;
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --text: #1f2937;
      --border: #d6deea;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(180deg, #f7f9fc 0%, var(--bg) 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
    }

    .app {
      width: min(840px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 14px 40px rgba(31, 41, 55, 0.08);
      padding: 28px;
    }

    h1 {
      margin: 0 0 20px;
      text-align: center;
      font-size: clamp(1.55rem, 2.2vw, 2rem);
      color: #0f172a;
    }

    form {
      display: grid;
      gap: 14px;
      max-width: 420px;
      margin: 0 auto 26px;
    }

    .form-logo {
      display: block;
      width: 210px;
      max-width: 100%;
      margin: 0 auto 2px;
      height: auto;
    }

    label {
      font-weight: 600;
      color: #334155;
    }

    input,
    button {
      width: 100%;
      font: inherit;
      border-radius: 10px;
    }

    input {
      height: 44px;
      border: 1px solid var(--border);
      padding: 0 12px;
      color: var(--text);
      background: #fff;
    }

    input:focus,
    button:focus {
      outline: 2px solid #93c5fd;
      outline-offset: 1px;
    }

    button {
      height: 44px;
      border: none;
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    button:hover {
      background: var(--primary-dark);
    }

    .returned-time {
      color: #0f172a;
      font-weight: 600;
    }

    .result-title {
      margin: 0 0 10px;
      font-size: 1.15rem;
      color: #0f172a;
    }

    .message {
      margin: 0 0 10px;
      color: #475569;
      font-weight: 600;
    }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 10px;
    }

    .log-reset-wrap {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
    }

    .log-reset-btn {
      width: auto;
      min-width: 190px;
      padding: 0 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 620px;
    }

    th,
    td {
      text-align: left;
      padding: 12px 14px;
      border-bottom: 1px solid #e5eaf2;
      color: #334155;
      white-space: nowrap;
    }

    thead th {
      background: #f1f5f9;
      font-size: 0.95rem;
      color: #1e293b;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    @media (max-width: 900px) {
      .app {
        width: min(760px, 100%);
        padding: 22px;
      }
    }

    @media (max-width: 640px) {
      body {
        padding: 20px 12px;
      }

      .app {
        padding: 18px;
      }

      form {
        max-width: 100%;
      }

      .form-logo {
        width: 180px;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <h1>OneCampus Admin Portal</h1>

    <form id="lookupForm" novalidate>
      <img class="form-logo" src="assets/onecampus-logo.png" alt="OneCampus logo" />

      <label for="lookupId">Student ID</label>
      <input id="lookupId" name="lookupId" type="text" inputmode="numeric" placeholder="Enter student ID" autocomplete="off" required />
      <button type="submit">Submit</button>
    </form>

    <h2 class="result-title">Student Activity Result</h2>
    <p id="statusMessage" class="message"></p>
    <div class="table-wrap">
      <table aria-label="Student activity results">
        <thead>
          <tr>
            <th>Date &amp; Time</th>
            <th>Student ID</th>
            <th>Location</th>
            <th>Timer</th>
            <th>Time Returned</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
    <div class="log-reset-wrap">
      <button id="resetLogBtn" class="log-reset-btn" type="button">Activity Log Reset</button>
    </div>
  </main>

  <script>
    const STORAGE_KEY = 'onecampusActivityLog';
    const LEGACY_KEYS = ['onecampusLog', 'activityLog'];
    const lookupForm = document.getElementById('lookupForm');
    const lookupId = document.getElementById('lookupId');
    const resultsBody = document.getElementById('resultsBody');
    const statusMessage = document.getElementById('statusMessage');
    const resetLogBtn = document.getElementById('resetLogBtn');
    const displayedEntryKeys = new Set();

    function formatElapsed(totalSeconds) {
      const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
      const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
      const seconds = String(totalSeconds % 60).padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    function normalizeStudentId(value) {
      return String(value || '')
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]/g, '');
    }

    function readEntriesFromKey(key) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) {
          return [];
        }
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) {
          return [];
        }
        return parsed
          .filter((entry) => entry && typeof entry === 'object')
          .map((entry) => ({
            dateTime: entry.dateTime || '',
            studentId: String(entry.studentId || ''),
            studentIdNormalized: normalizeStudentId(entry.studentIdNormalized || entry.studentId),
            location: entry.location || '',
            startMs: Number(entry.startMs) || Date.now(),
            returnedAtMs: Number(entry.returnedAtMs) || 0,
            stoppedSeconds: Number(entry.stoppedSeconds) || 0
          }));
      } catch {
        return [];
      }
    }

    function loadLogEntries() {
      const primaryEntries = readEntriesFromKey(STORAGE_KEY);
      if (primaryEntries.length > 0) {
        return primaryEntries;
      }

      for (const key of LEGACY_KEYS) {
        const legacyEntries = readEntriesFromKey(key);
        if (legacyEntries.length > 0) {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(legacyEntries));
          } catch {
            // Ignore storage write failures and continue with in-memory entries.
          }
          return legacyEntries;
        }
      }

      return [];
    }

    function clearResults() {
      resultsBody.textContent = '';
      displayedEntryKeys.clear();
    }

    function getEntryKey(entry) {
      return [
        entry.dateTime || '',
        normalizeStudentId(entry.studentIdNormalized || entry.studentId),
        entry.location || '',
        Number(entry.startMs) || 0
      ].join('|');
    }

    function renderResults(entries) {
      entries.forEach((entry) => {
        const entryKey = getEntryKey(entry);
        if (displayedEntryKeys.has(entryKey)) {
          return;
        }
        displayedEntryKeys.add(entryKey);

        const row = document.createElement('tr');
        const dateTimeCell = document.createElement('td');
        const studentCell = document.createElement('td');
        const locationCell = document.createElement('td');
        const timerCell = document.createElement('td');
        const returnedCell = document.createElement('td');

        dateTimeCell.textContent = entry.dateTime;
        studentCell.textContent = entry.studentId;
        locationCell.textContent = entry.location;
        timerCell.setAttribute('data-start', String(entry.startMs));
        timerCell.textContent = '00:00:00';
        if (entry.returnedAtMs > 0) {
          const stoppedSeconds = entry.stoppedSeconds > 0
            ? entry.stoppedSeconds
            : Math.max(0, Math.floor((entry.returnedAtMs - entry.startMs) / 1000));
          timerCell.setAttribute('data-stopped', 'true');
          timerCell.setAttribute('data-stopped-seconds', String(stoppedSeconds));
          timerCell.textContent = formatElapsed(stoppedSeconds);
          returnedCell.textContent = new Date(entry.returnedAtMs).toLocaleString();
          returnedCell.classList.add('returned-time');
        } else {
          timerCell.setAttribute('data-stopped', 'false');
          returnedCell.textContent = '';
        }

        row.append(dateTimeCell, studentCell, locationCell, timerCell, returnedCell);
        resultsBody.prepend(row);
      });
    }

    function updateTimers() {
      const timerCells = resultsBody.querySelectorAll('[data-start]');
      const nowMs = Date.now();

      timerCells.forEach((cell) => {
        if (cell.getAttribute('data-stopped') === 'true') {
          const stoppedSeconds = Number(cell.getAttribute('data-stopped-seconds')) || 0;
          cell.textContent = formatElapsed(stoppedSeconds);
          return;
        }
        const startMs = Number(cell.getAttribute('data-start'));
        const elapsed = Math.max(0, Math.floor((nowMs - startMs) / 1000));
        cell.textContent = formatElapsed(elapsed);
      });
    }

    lookupForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const studentId = lookupId.value.trim();
      const normalizedLookupId = normalizeStudentId(studentId);

      if (!normalizedLookupId) {
        statusMessage.textContent = 'student ID has not checked in';
        return;
      }

      const entries = loadLogEntries();
      const matches = entries.filter((entry) =>
        normalizeStudentId(entry.studentIdNormalized || entry.studentId) === normalizedLookupId
      );

      if (matches.length === 0) {
        statusMessage.textContent = 'student ID has not checked in';
        return;
      }

      statusMessage.textContent = '';
      renderResults(matches);
      updateTimers();
    });

    resetLogBtn.addEventListener('click', () => {
      clearResults();
      statusMessage.textContent = '';
    });

    lookupId.focus();
    setInterval(updateTimers, 1000);
  </script>
</body>
</html>
